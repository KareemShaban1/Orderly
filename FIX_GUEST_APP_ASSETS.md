# Fix Guest App Asset 404 Errors

## Problem
Getting 404 errors for guest app assets:
- `GET http://orderly.kareemsoft.org/assets/index-r-2bCAri.js net::ERR_ABORTED 404`
- `GET http://orderly.kareemsoft.org/registerSW.js net::ERR_ABORTED 404`
- `GET http://orderly.kareemsoft.org/assets/index-D3mYwgJO.css net::ERR_ABORTED 404`

## Root Causes

1. **Assets not built** - The guest app might not be built or dist folder is empty
2. **Wrong file paths** - Nginx config might not be mapping paths correctly
3. **Permissions** - Nginx (www user) can't read the files
4. **PWA files** - `registerSW.js` is a PWA service worker file that needs special handling

## Solutions

### Step 1: Verify Files Exist

```bash
# Check if dist folder exists and has content
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/

# Check if assets folder exists
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/assets/

# Check for PWA files
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/ | grep -E "(registerSW|sw\.js|manifest)"
```

### Step 2: Rebuild Guest App (if files missing)

```bash
cd /www/wwwroot/orderly.kareemsoft.org/frontend/guest

# Install dependencies if needed
npm install

# Build the app
npm run build

# Verify build output
ls -lh dist/
ls -lh dist/assets/
```

### Step 3: Fix Permissions

```bash
# Fix ownership
chown -R www:www /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist

# Fix directory permissions
chmod -R 755 /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist

# Fix file permissions
find /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist -type f -exec chmod 644 {} \;

# Verify Nginx can read
sudo -u www test -r /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/index.html && echo "✅ Can read" || echo "❌ Cannot read"
```

### Step 4: Update Nginx Config

The updated config includes:
1. `/assets/` location block for JS/CSS files
2. PWA files location block for `registerSW.js`, `sw.js`, `manifest.json`, icons
3. Root location block for HTML and React Router fallback

**Update your server's Nginx config** with the updated `nginx-orderly-config.conf`:

```bash
# Test config
nginx -t

# If OK, reload
systemctl reload nginx
```

### Step 5: Verify File Paths

The Nginx config uses `root` directive, which means:
- Request: `/assets/index-r-2bCAri.js`
- Nginx looks for: `/www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/assets/index-r-2bCAri.js`

Verify the actual file exists at that path:

```bash
# Check if the specific file exists
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/assets/index-r-2bCAri.js

# If file name is different, list all assets
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/assets/
```

### Step 6: Test HTTP Access

```bash
# Test assets
curl -I http://orderly.kareemsoft.org/assets/index-r-2bCAri.js

# Test PWA file
curl -I http://orderly.kareemsoft.org/registerSW.js

# Test CSS
curl -I http://orderly.kareemsoft.org/assets/index-D3mYwgJO.css

# All should return: HTTP/1.1 200 OK
```

## Common Issues

### Issue 1: Files Don't Exist After Build

**Check:**
```bash
# Verify build completed successfully
cd /www/wwwroot/orderly.kareemsoft.org/frontend/guest
npm run build

# Check for errors in build output
# Should see: "dist/index.html" created
```

**Solution:** Rebuild the app and check for TypeScript/build errors.

### Issue 2: Wrong Asset File Names

The asset file names are hashed (e.g., `index-r-2bCAri.js`). If you rebuild, the hash changes.

**Check:** The `index.html` file references the correct asset names:
```bash
# View index.html to see what assets it references
grep -o 'src="[^"]*"' /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/index.html
grep -o 'href="[^"]*"' /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/index.html
```

**Solution:** Make sure you're using the built `index.html` that matches the current build.

### Issue 3: registerSW.js Not Generated

`registerSW.js` is generated by `vite-plugin-pwa`. If it's missing:

**Check:**
```bash
# Check if vite-plugin-pwa is installed
grep "vite-plugin-pwa" /www/wwwroot/orderly.kareemsoft.org/frontend/guest/package.json

# Check if it's in dist folder
ls -la /www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist/registerSW.js
```

**Solution:** 
- Make sure `vite-plugin-pwa` is in `package.json`
- Rebuild the app
- Check build output for PWA-related messages

### Issue 4: Nginx Location Block Order

The location blocks must be in this order:
1. `/assets/` (most specific)
2. PWA files regex
3. `/` (catch-all, must be last)

**Verify:**
```bash
# Check location block order in config
grep -n "location" /www/server/panel/vhost/nginx/orderly.kareemsoft.org.conf | grep -E "(assets|registerSW|^[[:space:]]*location /)"
```

## Complete Diagnostic Script

```bash
#!/bin/bash

GUEST_DIST="/www/wwwroot/orderly.kareemsoft.org/frontend/guest/dist"

echo "=== Guest App Asset Diagnostic ==="
echo ""

# Check if dist exists
if [ ! -d "$GUEST_DIST" ]; then
    echo "❌ dist folder not found"
    echo "   Run: cd /www/wwwroot/orderly.kareemsoft.org/frontend/guest && npm run build"
    exit 1
fi

# Check index.html
if [ -f "$GUEST_DIST/index.html" ]; then
    echo "✅ index.html exists"
    FILE_SIZE=$(stat -c%s "$GUEST_DIST/index.html" 2>/dev/null || stat -f%z "$GUEST_DIST/index.html")
    echo "   Size: $FILE_SIZE bytes"
else
    echo "❌ index.html NOT FOUND"
fi

# Check assets folder
if [ -d "$GUEST_DIST/assets" ]; then
    ASSET_COUNT=$(find "$GUEST_DIST/assets" -type f | wc -l)
    echo "✅ assets folder exists with $ASSET_COUNT files"
    
    # List first few files
    echo "   Sample files:"
    ls "$GUEST_DIST/assets" | head -3 | while read file; do
        echo "     - $file"
    done
else
    echo "❌ assets folder NOT FOUND"
fi

# Check PWA files
echo ""
echo "=== PWA Files ==="
for file in registerSW.js sw.js manifest.json; do
    if [ -f "$GUEST_DIST/$file" ]; then
        echo "✅ $file exists"
    else
        echo "⚠️  $file not found (may be optional)"
    fi
done

# Check permissions
echo ""
echo "=== Permissions ==="
if sudo -u www test -r "$GUEST_DIST/index.html" 2>/dev/null; then
    echo "✅ Nginx can read files"
else
    echo "❌ Permission issue"
    echo "   Fix: chown -R www:www $GUEST_DIST"
fi

# Test HTTP
echo ""
echo "=== HTTP Test ==="
HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "http://orderly.kareemsoft.org/" 2>/dev/null)
if [ "$HTTP_CODE" = "200" ]; then
    echo "✅ Root URL returns 200"
else
    echo "❌ Root URL returns: $HTTP_CODE"
fi

echo ""
echo "=== Diagnostic Complete ==="
```

## After Fixing

1. **Clear browser cache** (Ctrl+Shift+R or Cmd+Shift+R)
2. **Open DevTools** (F12) → Network tab
3. **Refresh page** and verify:
   - All assets load with 200 status
   - No 404 errors
   - Page renders correctly

## Quick Fix Checklist

- [ ] Guest app rebuilt: `cd frontend/guest && npm run build`
- [ ] Files exist in `dist/` and `dist/assets/`
- [ ] Permissions fixed: `chown -R www:www dist`
- [ ] Nginx config updated with PWA files location block
- [ ] Nginx reloaded: `systemctl reload nginx`
- [ ] Tested with curl: `curl -I http://orderly.kareemsoft.org/assets/...`
- [ ] Browser cache cleared
- [ ] No errors in browser console

